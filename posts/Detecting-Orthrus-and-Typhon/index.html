<!DOCTYPE html><html lang="en" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Detecting Orthrus and Typhon" /><meta property="og:locale" content="en" /><meta name="description" content="On 5th August 2021, we (Calum @_calumhall and Luke @rookuu_) presented at Black Hat USA, with our talk “Come to The Dark Side We Have Apples: Turning macOS Management Evil”. The talk discusses methods of using and abusing Jamf and MDM in an offensive operation, and specifically relevent to this post - as initial access implants." /><meta property="og:description" content="On 5th August 2021, we (Calum @_calumhall and Luke @rookuu_) presented at Black Hat USA, with our talk “Come to The Dark Side We Have Apples: Turning macOS Management Evil”. The talk discusses methods of using and abusing Jamf and MDM in an offensive operation, and specifically relevent to this post - as initial access implants." /><link rel="canonical" href="https://themacpack.io/posts/Detecting-Orthrus-and-Typhon/" /><meta property="og:url" content="https://themacpack.io/posts/Detecting-Orthrus-and-Typhon/" /><meta property="og:site_name" content="The Mac Pack" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-08-05T06:00:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Detecting Orthrus and Typhon" /><meta name="google-site-verification" content="MYTSDlklSUo7pooK7H-33Y6WOZ7YGvajvC8_pi5Ue7E" /> <script type="application/ld+json"> {"headline":"Detecting Orthrus and Typhon","dateModified":"2021-08-05T17:41:26+01:00","datePublished":"2021-08-05T06:00:00+01:00","description":"On 5th August 2021, we (Calum @_calumhall and Luke @rookuu_) presented at Black Hat USA, with our talk “Come to The Dark Side We Have Apples: Turning macOS Management Evil”. The talk discusses methods of using and abusing Jamf and MDM in an offensive operation, and specifically relevent to this post - as initial access implants.","url":"https://themacpack.io/posts/Detecting-Orthrus-and-Typhon/","mainEntityOfPage":{"@type":"WebPage","@id":"https://themacpack.io/posts/Detecting-Orthrus-and-Typhon/"},"@type":"BlogPosting","@context":"https://schema.org"}</script><title>Detecting Orthrus and Typhon | The Mac Pack</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="The Mac Pack"><meta name="application-name" content="The Mac Pack"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div class="site-title mt-3"> <a href="/">The Mac Pack</a></div><div class="site-subtitle font-italic">A collection of macOS flavoured content.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/themacpack" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Detecting Orthrus and Typhon</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Detecting Orthrus and Typhon</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> TheMacPack </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Thu, Aug 5, 2021, 6:00 AM +0100" >Aug 5<i class="unloaded">2021-08-05T06:00:00+01:00</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Thu, Aug 5, 2021, 5:41 PM +0100" >Aug 5<i class="unloaded">2021-08-05T17:41:26+01:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="730 words">4 min read</span></div></div><div class="post-content"> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 501 211'%3E%3C/svg%3E" data-proofer-ignore data-src="/assets/img/detecting-orthrus-and-typhon/blackhat2021_logo.png" class="preview-img" alt="Black Hat USA 2021 Logo" width="501" height="211"><p>On 5th August 2021, we (<a href="https://twitter.com/_calumhall">Calum @_calumhall</a> and <a href="https://twitter.com/rookuu_">Luke @rookuu_</a>) presented at Black Hat USA, with our talk “Come to The Dark Side We Have Apples: Turning macOS Management Evil”. The talk discusses methods of using and abusing Jamf and MDM in an offensive operation, and specifically relevent to this post - as initial access implants.</p><p>To facilite the research, we created two <a href="https://github.com/its-a-feature/Mythic">Mythic</a> agents. In this post, we wanted to outline some of the ideas we’ve had to detect the agents and their respective activity. Most of the detection opportunities below are targeted towards the installation of the agents, as opposed to the malicious activity post compromise. This is because by nature, the agents are designed to blend in with the legitimate management software extant within the target’s estate.</p><h2 id="orthrus">Orthrus</h2><p><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 300'%3E%3C/svg%3E" data-proofer-ignore data-src="/assets/img/detecting-orthrus-and-typhon/orthrus.svg" alt="orthrus logo" width="300" height="300" /> <em>Orthrus: A Mythic agent utilising mdmclient and APNs.</em></p><p>Orthrus is a implant and C2 mechanism that uses Apple’s MDMClient and Push Notification Service. Effectively, the operator coerces a target to enroll into their malicious MDM server, gaining (some) control over the device. Full documentation, installation and usage instructions can be found <a href="https://github.com/MythicAgents/orthrus">here</a>.</p><h3 id="malicious-mobileconfig-downloaded-from-the-internet">Malicious .mobileconfig Downloaded from the Internet.</h3><p>In order to compromise a target with Orthrus, a malicious .mobileconfig file must be generated, and installed as a MDM profile on the target device. This is typically performed by sending the file to the target, via email or web download, along with some pretext about $COMPANY IT needing to fix their device. This action would be logged when the file is created, for example, using <a href="https://developer.apple.com/documentation/endpointsecurity/es_event_create_t">ESF: File Create</a>.</p><p><strong>Detection:</strong> Raise alert for files ending in <code class="language-plaintext highlighter-rouge">.mobileconfig</code> that have been downloaded from the internet or send via email.</p><h3 id="device-enrolled-in-a-different-mdm-server">Device Enrolled in a (Different) MDM Server.</h3><p>The exact nature of this idea will depend on whether you run MDM already within your organisation. If you don’t, then naturally devices that are suddenly enrolled into an MDM server is cause for concern. Similarly, if devices are enrolled in MDM servers OTHER than yours, this is indicative of a threat actor using similar techniques to those used by Orthrus.</p><p><strong>Detection:</strong> Use something like <a href="https://github.com/osquery/osquery/blob/master/specs/darwin/managed_policies.table">OSQuery</a> to check for profiles on a device, to see if/what MDM profile is installed.</p><h3 id="uninstall-mdm-message">Uninstall MDM Message</h3><p>Similar to the previous idea, if an organisation is already using MDM then they are able to tell if a device has uninstalled the profile. When an MDM profile is uninstalled, it sends a <code class="language-plaintext highlighter-rouge">CheckOut</code> message. See the <a href="https://developer.apple.com/business/documentation/MDM-Protocol-Reference.pdf">MDM Protocol Reference (Page 13)</a>.</p><p><strong>Detection:</strong> Use existing MDM solution to monitor for <code class="language-plaintext highlighter-rouge">CheckOut</code> messages.</p><h2 id="typhon">Typhon</h2><p><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 300'%3E%3C/svg%3E" data-proofer-ignore data-src="/assets/img/detecting-orthrus-and-typhon/typhon.svg" alt="typhon logo" width="300" height="300" /> <em>Typhon: A Mythic agent designed to exploit Jamf managed devices.</em></p><p>Typhon is a Mythic agent that was developed to enable device takeover attacks against Jamf managed workstations. This agent &amp; profile combination enables an attacker to imitate the behaviour of a Jamf server within macOS environments, and as such operate in a covert manner.</p><h3 id="alteration-of-the-jamf-configuration">Alteration of the Jamf Configuration</h3><p>Typhon was designed as a means of taking over control of Jamf enrolled devices - without introducing any custom code. Jamf operates on a client server model where the client side agent relies on a configuration file to determine which server to communicate with. The typhon agent provides the user with a custom Jamf configuration file, that once placed within <code class="language-plaintext highlighter-rouge">/Library/Preferences/com.jamfsoftware.jamf.plist</code> on the device will cause the endpoint to communicate with the specified Mythic server.</p><p><strong>Detection:</strong> It is highly unusual for any process other than Jamf to interact with the Jamf configuration file (with the exception of a few default system utilities). Alerts should be raised for any alterations made to this file by non-standard processes. Additionally, it may be possible using tools such as osquery to monitor for changes to the configuration file’s hash value.</p><h3 id="device-health-check">Device Health Check</h3><p>This type of device takeover attack currently prevents the compromised device from checking in to the legitimate Jamf server.</p><p><strong>Detection:</strong> It may be possible to implement a device health check within your environment to identify devices that have not checked in for a prolonged period of time.</p><h3 id="code-execution">Code Execution</h3><p>Whilst the Jamf agent does legitimately execute bash commands within the majority of environments. It should not be assumed that any commands performed by this binary are legitimate. As attacks like this have demonstrated, the Jamf agent may be abused to perform malicious activity on behalf a malicious user.</p><p><strong>Detection:</strong> Ensure that the Jamf binary is not whitelisted from current device detections.</p></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/blue/" class="post-tag no-text-decoration" >Blue</a> <a href="/tags/detection/" class="post-tag no-text-decoration" >Detection</a> <a href="/tags/black-hat/" class="post-tag no-text-decoration" >Black Hat</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Detecting Orthrus and Typhon - The Mac Pack&url=https://themacpack.io/posts/Detecting-Orthrus-and-Typhon/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Detecting Orthrus and Typhon - The Mac Pack&u=https://themacpack.io/posts/Detecting-Orthrus-and-Typhon/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Detecting Orthrus and Typhon - The Mac Pack&url=https://themacpack.io/posts/Detecting-Orthrus-and-Typhon/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink('', 'Link copied successfully!')" data-toggle="tooltip" data-placement="top" title="Copy link"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Detecting-Orthrus-and-Typhon/">Detecting Orthrus and Typhon</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/black-hat/">Black Hat</a> <a class="post-tag" href="/tags/blue/">Blue</a> <a class="post-tag" href="/tags/detection/">Detection</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div class="post-navigation d-flex justify-content-between"> <span class="btn btn-outline-primary disabled" prompt="Older"><p>-</p></span> <span class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></span></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://github.com/themackpack">TheMacPack</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/black-hat/">Black Hat</a> <a class="post-tag" href="/tags/blue/">Blue</a> <a class="post-tag" href="/tags/detection/">Detection</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://themacpack.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
